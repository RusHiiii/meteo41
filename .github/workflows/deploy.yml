name: Full CI deploy process for Symfony
on:
    push:
        branches:
            - production
jobs:
    deploy:
        name: Meteo41 - Deploy
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v2
            - name: Install Open VPN
              run: |
                  sudo apt-get install openvpn
                  echo "${{ secrets.LOGIN_FILE }}" > .github/vpn/login

            - name: Connect VPN
              uses: golfzaptw/action-connect-ovpn@master
              id: connect_vpn
              with:
                  PING_URL: '127.0.0.1'
                  FILE_OVPN: '.github/vpn/config.ovpn'
                  SECRET: ${{ secrets.SECRET_USERNAME_PASSWORD }}
                  TLS_KEY: ${{ secrets.TLS_KEY }}
              env:
                  CA_CRT: ${{ secrets.CA_CRT}}
                  USER_CRT: ${{ secrets.USER_CRT }}
                  USER_KEY: ${{ secrets.USER_KEY }}

            - name: Check Connect VPN
              run: echo ${{ steps.connect_vpn.outputs.STATUS }}

            - name: kill vpn
              if: always()
              run: sudo killall openvpn